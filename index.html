<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open House Appointments</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 600px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Open House Appointments</h1>
        <p class="text-gray-600 mb-6">Unit 11C, 125 W 21st Street, NYC, NY 10011</p>
        
        <p class="text-gray-700 mb-4">Please select a time slot to reserve your spot at one of our upcoming open houses. You will receive an email confirmation with the details.</p>

        <!-- Showing times container -->
        <div id="showings-container" class="space-y-4">
            <!-- Appointments will be dynamically added here -->
            <div class="text-center text-gray-500 mt-8">Loading available time slots...</div>
        </div>

        <!-- Appointment Modal (Initially hidden) -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm relative">
                <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h2 id="modal-title" class="text-2xl font-semibold mb-4 text-gray-800">Confirm Appointment</h2>
                <form id="appointment-form" onsubmit="handleFormSubmit(event)">
                    <div class="mb-4">
                        <label for="name" class="block text-gray-700 font-medium mb-1">Full Name</label>
                        <input type="text" id="name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-medium mb-1">Email</label>
                        <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Confirm</button>
                </form>
                <p id="success-message" class="text-green-600 font-medium mt-4 text-center hidden">Thank you! Your appointment has been scheduled.</p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global variables for Firebase
        let db;
        let auth;
        let appId;
        const SHOWINGS_COLLECTION = 'showings';

        // Get global variables from canvas environment
        const firebaseConfig = JSON.parse(__firebase_config);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // UI elements
        const showingsContainer = document.getElementById('showings-container');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const appointmentForm = document.getElementById('appointment-form');
        const successMessage = document.getElementById('success-message');

        let selectedShowing = null;

        // Function to get the date of the next specific day of the week
        function getNextDay(dayOfWeek) {
            const today = new Date();
            const resultDate = new Date(today);
            resultDate.setDate(today.getDate() + (dayOfWeek + 7 - today.getDay()) % 7);
            return resultDate;
        }

        // Generate dynamic showings
        function generateShowingsData() {
            const wednesday = getNextDay(3); // 3 is Wednesday
            const sunday = getNextDay(0); // 0 is Sunday
            
            // To ensure we always show the next two upcoming dates, adjust if today is the day of an open house
            const today = new Date();
            if (wednesday.toDateString() === today.toDateString() && today.getHours() >= 19) { // 7 PM
                wednesday.setDate(wednesday.getDate() + 7);
            }
            if (sunday.toDateString() === today.toDateString() && today.getHours() >= 15) { // 3 PM
                sunday.setDate(sunday.getDate() + 7);
            }

            const showings = [];
            // Use Intl.DateTimeFormat for robust date formatting
            const formatter = new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            const wednesdayString = formatter.format(wednesday);
            const sundayString = formatter.format(sunday);

            showings.push({
                id: `wed_${wednesday.getFullYear()}_${wednesday.getMonth() + 1}_${wednesday.getDate()}`,
                date: wednesdayString,
                time: '6:00 PM - 7:00 PM'
            });

            showings.push({
                id: `sun_${sunday.getFullYear()}_${sunday.getMonth() + 1}_${sunday.getDate()}`,
                date: sundayString,
                time: '1:00 PM - 3:00 PM'
            });

            return showings;
        }

        // Open the modal for a specific showing
        window.openModal = function(id, date, time) {
            selectedShowing = { id, date, time };
            modalTitle.textContent = `Schedule for ${date} - ${time}`;
            appointmentForm.reset();
            appointmentForm.style.display = 'block';
            successMessage.style.display = 'none';
            modal.classList.remove('hidden');
        }

        // Close the modal
        window.closeModal = function() {
            modal.classList.add('hidden');
        }

        // Handle form submission
        window.handleFormSubmit = async function(event) {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;

            if (!selectedShowing) {
                console.error('No showing selected.');
                return;
            }

            try {
                const bookingsCollection = collection(db, 'artifacts', appId, 'public/data', SHOWINGS_COLLECTION, selectedShowing.id, 'bookings');
                await addDoc(bookingsCollection, { name, email, bookedAt: new Date() });

                appointmentForm.style.display = 'none';
                successMessage.style.display = 'block';

            } catch (error) {
                console.error("Error adding appointment:", error);
                // In a real app, you'd show a user-facing error message here
            }
        };

        // Fetch and render showings from Firestore in real-time
        function fetchAndRenderShowings() {
            const showingsData = generateShowingsData();
            showingsContainer.innerHTML = '';
            
            showingsData.forEach((showing) => {
                const showingElement = document.createElement('div');
                showingElement.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-md border border-gray-200';
                showingElement.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${showing.date}</p>
                        <p class="text-gray-600">${showing.time}</p>
                    </div>
                    <button id="button-${showing.id}" onclick="openModal('${showing.id}', '${showing.date}', '${showing.time}')" class="bg-indigo-600 text-white text-sm font-semibold py-2 px-4 rounded-full shadow hover:bg-indigo-700 transition-colors">
                        Sign Up
                    </button>
                `;
                showingsContainer.appendChild(showingElement);

                // Listen for changes to the bookings subcollection
                const bookingsCollection = collection(db, 'artifacts', appId, 'public/data', SHOWINGS_COLLECTION, showing.id, 'bookings');
                onSnapshot(bookingsCollection, (snapshot) => {
                    const count = snapshot.size;
                    const button = document.getElementById(`button-${showing.id}`);
                    if (button) {
                        button.textContent = `Sign Up (${count} booked)`;
                    }
                });
            });
        }

        // Initialize the app with authentication
        async function initializeAppWithAuth() {
            try {
                // First, sign in anonymously or with the custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Once authenticated, fetch and render the showings
                fetchAndRenderShowings();

            } catch (error) {
                console.error("Error initializing app with authentication:", error);
                // Display a user-friendly error message if the app can't connect
                showingsContainer.innerHTML = `<div class="text-center text-red-500 mt-8">Sorry, there was an error loading the time slots. Please try again later.</div>`;
            }
        }
        
        initializeAppWithAuth();
    </script>
</body>
</html>