<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Private Showing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Open House By Appointment</h1>
        <p class="text-gray-600 mb-6 text-center">Book your private showing for Unit 11C.</p>

        <div id="loading-message" class="text-center text-gray-500 mb-4">Loading open house dates...</div>
        <div id="booking-container" class="space-y-6">
            <!-- Dynamic showing slots will be inserted here -->
        </div>

        <!-- Hidden modal for messages -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                <p id="modal-message" class="text-lg font-medium text-gray-800 mb-4">Booking successful!</p>
                <button id="modal-close-button" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Enable debug logging for Firestore
        setLogLevel('debug');

        // Global variables for Firebase
        let db;
        let auth;
        const SHOWINGS_COLLECTION = 'showings';

        // NOTE: This Firebase configuration is the one provided by you and is embedded
        // directly in this file so that it will work on your live website.
        const firebaseConfig = {
            apiKey: "AIzaSyDsTvu7ikH4I9ToUIOfqRTJGrHIl2fzmKQ",
            authDomain: "indigo11cappointment.firebaseapp.com",
            projectId: "indigo11cappointment",
            storageBucket: "indigo11cappointment.firebasestorage.app",
            messagingSenderId: "757509071845",
            appId: "1:757509071845:web:6bdf9a5e25e324d9f2850c",
            measurementId: "G-8TBMDP8QVW"
        };
        const appId = "indigo11cappointment";

        // UI Elements
        const bookingContainer = document.getElementById('booking-container');
        const loadingMessage = document.getElementById('loading-message');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        // Function to show a message modal
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Function to hide the message modal
        modalCloseButton.addEventListener('click', () => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        });

        // Function to get the date of the next specific day of the week
        function getNextDay(dayOfWeek) {
            const today = new Date();
            const resultDate = new Date(today);
            resultDate.setDate(today.getDate() + (dayOfWeek + 7 - today.getDay()) % 7);
            return resultDate;
        }

        // Function to generate showing slots
        function generateShowingSlots() {
            const wednesday = getNextDay(3); // 3 is Wednesday
            const sunday = getNextDay(0); // 0 is Sunday
            
            // To ensure we always show the next two upcoming dates, adjust if today is the day of an open house
            const today = new Date();
            if (wednesday.toDateString() === today.toDateString()) {
                wednesday.setDate(wednesday.getDate() + 7);
            }
            if (sunday.toDateString() === today.toDateString()) {
                sunday.setDate(sunday.getDate() + 7);
            }

            const showings = [];
            const formatter = new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            // Pushing Sunday first to show it first on the page
            showings.push({
                id: `sun_${sunday.getFullYear()}_${sunday.getMonth() + 1}_${sunday.getDate()}`,
                date: formatter.format(sunday),
                time: '1:00 PM - 3:00 PM'
            });

            // Pushing Wednesday second
            showings.push({
                id: `wed_${wednesday.getFullYear()}_${wednesday.getMonth() + 1}_${wednesday.getDate()}`,
                date: formatter.format(wednesday),
                time: '6:00 PM - 7:00 PM'
            });

            return showings;
        }

        // Initialize Firebase and set up the authentication state listener
        async function initializeAppWithAuth() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    loadingMessage.textContent = "Firebase configuration is missing.";
                    console.error("Firebase config is missing.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in anonymously to authenticate with Firestore
                const initialAuthToken = null; // We are not using Canvas token in this version
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Render the booking slots after successful authentication
                renderBookingSlots();

            } catch (error) {
                console.error("Error initializing app with authentication:", error);
                loadingMessage.textContent = "Failed to connect to Firebase.";
            }
        }

        // Function to render the booking slots
        function renderBookingSlots() {
            loadingMessage.textContent = ''; // Hide loading message
            const showingSlots = generateShowingSlots();

            showingSlots.forEach(slot => {
                const slotHTML = `
                    <div class="bg-gray-50 rounded-lg p-6 shadow-sm">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">${slot.date}</h2>
                        <p class="text-gray-600 mb-4">${slot.time}</p>
                        
                        <form id="form-${slot.id}" class="space-y-4">
                            <div>
                                <label for="name-${slot.id}" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="name-${slot.id}" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="email-${slot.id}" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="email-${slot.id}" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                Book Now
                            </button>
                        </form>
                    </div>
                `;
                bookingContainer.innerHTML += slotHTML;
                
                // Add form submission listener
                const form = document.getElementById(`form-${slot.id}`);
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById(`name-${slot.id}`).value;
                    const email = document.getElementById(`email-${slot.id}`).value;
                    
                    try {
                        const bookingsCollectionPath = `artifacts/${appId}/public/data/${SHOWINGS_COLLECTION}/${slot.id}/bookings`;
                        await addDoc(collection(db, bookingsCollectionPath), {
                            name: name,
                            email: email,
                            timestamp: new Date()
                        });
                        showModal("Booking successful! We look forward to seeing you.");
                        form.reset();
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        showModal("An error occurred. Please try again later.");
                    }
                });
            });
        }

        initializeAppWithAuth();
    </script>
</body>
</html>
