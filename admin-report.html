<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open House Bookings Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Open House Bookings Report</h1>
        <p class="text-gray-600 mb-6">Real-time appointments for Unit 11C</p>

        <div id="report-container" class="space-y-6">
            <!-- Report content will be dynamically generated here -->
            <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg">
                <p class="text-gray-500 text-lg">Loading bookings...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('debug');

        // Global variables for Firebase
        let db;
        let auth;
        let appId;
        const SHOWINGS_COLLECTION = 'showings';
        const APP_ID = 'YOUR_APP_ID_HERE'; // **IMPORTANT: Replace with your actual app ID from Firebase**

        // **1. PASTE YOUR FIREBASE CONFIG HERE**
        // You can find this in your Firebase Project Settings -> General
        // It should look like this:
        /*
        const firebaseConfig = {
          apiKey: "AIzaSy...",
          authDomain: "your-app.firebaseapp.com",
          projectId: "your-app",
          storageBucket: "your-app.appspot.com",
          messagingSenderId: "123456789",
          appId: "1:23456789:web:abcdef"
        };
        */
        const firebaseConfig = {
          // Paste your config details here
        };

        // 2. DO NOT CHANGE ANYTHING BELOW THIS LINE
        // The code below is designed to work with your configuration.

        // Get global variables from canvas environment
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;

        // UI elements
        const reportContainer = document.getElementById('report-container');

        // Function to get the date of the next specific day of the week
        function getNextDay(dayOfWeek) {
            const today = new Date();
            const resultDate = new Date(today);
            resultDate.setDate(today.getDate() + (dayOfWeek + 7 - today.getDay()) % 7);
            return resultDate;
        }

        // Generate dynamic showings with the correct IDs
        function generateShowingsData() {
            const wednesday = getNextDay(3); // 3 is Wednesday
            const sunday = getNextDay(0); // 0 is Sunday
            
            // To ensure we always show the next two upcoming dates, adjust if today is the day of an open house
            if (wednesday.toDateString() === new Date().toDateString()) {
                wednesday.setDate(wednesday.getDate() + 7);
            }
            if (sunday.toDateString() === new Date().toDateString()) {
                sunday.setDate(sunday.getDate() + 7);
            }
            
            const showings = [];
            const formatter = new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            showings.push({
                id: `wed_${wednesday.getFullYear()}_${wednesday.getMonth() + 1}_${wednesday.getDate()}`,
                date: formatter.format(wednesday),
                time: '6:00 PM - 7:00 PM'
            });

            showings.push({
                id: `sun_${sunday.getFullYear()}_${sunday.getMonth() + 1}_${sunday.getDate()}`,
                date: formatter.format(sunday),
                time: '1:00 PM - 3:00 PM'
            });

            return showings;
        }

        // Function to fetch and render the report
        function fetchAndRenderReport() {
            const showingsData = generateShowingsData();
            reportContainer.innerHTML = ''; // Clear the container

            showingsData.forEach(showing => {
                const showingsSection = document.createElement('div');
                showingsSection.className = 'bg-white p-6 rounded-lg shadow-md';
                showingsSection.innerHTML = `
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">${showing.date} - ${showing.time}</h2>
                    <ul id="bookings-list-${showing.id}" class="space-y-2 text-gray-700 list-disc list-inside ml-4">
                        <li class="text-gray-500">No bookings yet.</li>
                    </ul>
                `;
                reportContainer.appendChild(showingsSection);

                // Listen for real-time updates to the bookings subcollection
                const bookingsCollectionPath = `artifacts/${appId}/public/data/${SHOWINGS_COLLECTION}/${showing.id}/bookings`;
                const bookingsQuery = collection(db, bookingsCollectionPath);
                const bookingsList = document.getElementById(`bookings-list-${showing.id}`);

                onSnapshot(bookingsQuery, (snapshot) => {
                    if (snapshot.empty) {
                        bookingsList.innerHTML = '<li class="text-gray-500">No bookings yet.</li>';
                    } else {
                        bookingsList.innerHTML = '';
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const listItem = document.createElement('li');
                            listItem.textContent = `${data.name} (${data.email})`;
                            bookingsList.appendChild(listItem);
                        });
                    }
                }, (error) => {
                    console.error("Error fetching bookings:", error);
                    bookingsList.innerHTML = `<li class="text-red-500">Error loading bookings.</li>`;
                });
            });
        }

        // Initialize the app with authentication
        async function initializeAppWithAuth() {
            try {
                // Check if Firebase config is available
                if (Object.keys(firebaseConfig).length === 0 && firebaseConfig.constructor === Object) {
                    console.error("Firebase config is missing.");
                    reportContainer.innerHTML = '<p class="text-red-500 text-center">Firebase configuration is missing. Please add it to the code.</p>';
                    return;
                }

                // Initialize Firebase services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Fetch and render the report after successful authentication
                fetchAndRenderReport();

            } catch (error) {
                console.error("Error initializing app with authentication:", error);
                reportContainer.innerHTML = '<p class="text-red-500 text-center">Failed to connect to Firebase. Please check your configuration.</p>';
            }
        }
        
        initializeAppWithAuth();
    </script>
</body>
</html>
