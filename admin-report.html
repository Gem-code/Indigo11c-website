<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open House Bookings Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 800px;
        }
        .booking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Open House Bookings Report</h1>
        <p class="text-gray-600 mb-6">Real-time appointments for Unit 11C</p>

        <div id="report-container" class="space-y-6">
            <!-- Report content will be dynamically generated here -->
            <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg">
                <p class="text-gray-500 text-lg">Loading bookings...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        
        // Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyDsTvu7ikH4I9ToUIOfqRTJGrHIl2fzmKQ",
            authDomain: "indigo11cappointment.firebaseapp.com",
            projectId: "indigo11cappointment",
            storageBucket: "indigo11cappointment.firebasestorage.app",
            messagingSenderId: "757509071845",
            appId: "1:757509071845:web:6bdf9a5e25e324d9f2850c",
            measurementId: "G-8TBMDP8QVW"
        };
        
        // This variable now uses the projectId from your config, ensuring it's always correct.
        const appId = firebaseConfig.projectId;
        const SHOWINGS_COLLECTION = 'showings';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // UI elements
        const reportContainer = document.getElementById('report-container');

        // Function to get the date of the next specific day of the week
        function getNextDay(dayOfWeek) {
            const today = new Date();
            const resultDate = new Date(today);
            resultDate.setDate(today.getDate() + (dayOfWeek + 7 - today.getDay()) % 7);
            return resultDate;
        }

        // Generate dynamic showings with the correct IDs
        function generateShowingsData() {
            const wednesday = getNextDay(3); // 3 is Wednesday
            const sunday = getNextDay(0); // 0 is Sunday
            
            // To ensure we always show the next two upcoming dates, adjust if today is the day of an open house
            const today = new Date();
            if (wednesday.toDateString() === today.toDateString()) {
                wednesday.setDate(wednesday.getDate() + 7);
            }
            if (sunday.toDateString() === today.toDateString()) {
                sunday.setDate(sunday.getDate() + 7);
            }
            
            const showings = [];
            const formatter = new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            showings.push({
                id: `wed_${wednesday.getFullYear()}_${wednesday.getMonth() + 1}_${wednesday.getDate()}`,
                date: formatter.format(wednesday),
                time: '6:00 PM - 7:00 PM'
            });

            showings.push({
                id: `sun_${sunday.getFullYear()}_${sunday.getMonth() + 1}_${sunday.getDate()}`,
                date: formatter.format(sunday),
                time: '1:00 PM - 3:00 PM'
            });

            return showings;
        }

        // Function to fetch and render the report
        function fetchAndRenderReport() {
            const showingsData = generateShowingsData();
            reportContainer.innerHTML = ''; // Clear the container

            // Sign in anonymously to authenticate with Firestore
            signInAnonymously(auth).then(() => {
                showingsData.forEach(showing => {
                    const showingsSection = document.createElement('div');
                    showingsSection.className = 'bg-white p-6 rounded-lg shadow-md';
                    showingsSection.innerHTML = `
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">${showing.date} - ${showing.time}</h2>
                        <ul id="bookings-list-${showing.id}" class="space-y-2 text-gray-700 list-disc list-inside ml-4">
                            <li class="text-gray-500">No bookings yet.</li>
                        </ul>
                    `;
                    reportContainer.appendChild(showingsSection);

                    // Listen for real-time updates to the bookings subcollection
                    const bookingsCollectionPath = `artifacts/${appId}/public/data/${SHOWINGS_COLLECTION}/${showing.id}/bookings`;
                    const bookingsQuery = collection(db, bookingsCollectionPath);
                    const bookingsList = document.getElementById(`bookings-list-${showing.id}`);

                    onSnapshot(bookingsQuery, (snapshot) => {
                        bookingsList.innerHTML = ''; // Clear existing bookings

                        if (snapshot.empty) {
                            bookingsList.innerHTML = '<li class="text-gray-500">No bookings yet.</li>';
                            return;
                        }

                        snapshot.forEach((doc) => {
                            const booking = doc.data();
                            const listItem = document.createElement('li');
                            listItem.className = 'booking-item text-sm sm:text-base';
                            listItem.innerHTML = `
                                <div>
                                    <span class="font-medium">${booking.name}</span>
                                    <span class="text-gray-500">(${booking.email})</span>
                                </div>
                            `;
                            bookingsList.appendChild(listItem);
                        });
                    }, (error) => {
                        console.error("Error fetching bookings: ", error);
                        bookingsList.innerHTML = '<li class="text-red-500">Error loading bookings.</li>';
                    });
                });
            }).catch(error => {
                console.error("Authentication failed: ", error);
                reportContainer.innerHTML = '<div class="text-center text-red-500 p-8">Error initializing app with authentication.</div>';
            });
        }

        // Start the process
        if (firebaseConfig.apiKey && firebaseConfig.authDomain) {
            fetchAndRenderReport();
        } else {
            reportContainer.innerHTML = '<div class="text-center text-red-500 p-8">Firebase configuration is missing. This app is not connected to a Firebase project.</div>';
        }
    </script>
</body>
</html>
